<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="cn.com.ecrf.trq.repository.CRFMapper">
	<resultMap id="patientInfoResultMap" type="cn.com.ecrf.trq.model.PatientInfoCase" >
	    <id column="id" property="id" jdbcType="INTEGER" />
	    <result column="no" property="no" jdbcType="VARCHAR" />
	    <result column="name" property="name" jdbcType="VARCHAR" />
	    <result column="abbr" property="abbr" jdbcType="VARCHAR" />
	    <result column="birthday" property="birthday" jdbcType="TIMESTAMP" />
	    <result column="age" property="age" jdbcType="INTEGER" />
	    <result column="weight" property="weight" jdbcType="FLOAT" />
	    <result column="sex" property="sex" jdbcType="VARCHAR" />
	    <result column="ethic" property="ethic" jdbcType="VARCHAR" />
	    <result column="hys" property="hys" jdbcType="VARCHAR" />
	    <result column="height" property="height" jdbcType="INTEGER" />
	    <result column="yyks" property="yyks" jdbcType="VARCHAR" />
	    <result column="ryrq" property="ryrq" jdbcType="TIMESTAMP" />
	    <result column="cyrq" property="cyrq" jdbcType="TIMESTAMP" />
	    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
	    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
	    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
	    <result column="update_by" property="updateBy" jdbcType="VARCHAR" />
	</resultMap>
	<insert id="insertPatientInfo" parameterType="cn.com.ecrf.trq.model.PatientInfoCase">
      	<selectKey resultType="Integer" order="AFTER" keyProperty="id">
		SELECT LAST_INSERT_ID()
		</selectKey>
	    insert into crf_patient_info (id, no, name, abbr, birthday, age,
	      weight, sex, ethic, hys, height, yyks, ryrq, cyrq, ylfyfs, create_time, create_by)
	    values (#{id}, #{no}, #{name}, #{abbr}, #{birthday}, #{age}, 
	      #{weight}, #{sex}, #{ethic}, #{hys}, #{height}, #{yyks}, #{ryrq}, #{cyrq}, #{ylfyfs}, 
	      current_timestamp(), createBy)
	</insert>
	<update id="updatePatientInfo" parameterType="cn.com.ecrf.trq.model.PatientInfoCase" >
		update ac_user set
		user_name=#{userName}, password=#{password}, display_name=#{displayName},
		status=#{status}, update_time= now()
		<if test="organizationId != null" >
        	,fk_organization_id=#{organizationId}
      	</if>
      	<if test="emailAddress != null" >
        	,email_address=#{emailAddress}
      	</if>
      	<if test="updateBy != null" >
        	,update_by=#{updateBy}
      	</if>
  		where id=#{id}
	    update crf_patient_info (id, no, name, abbr, birthday, age,
	      weight, sex, ethic, hys, height, yyks, ryrq, cyrq, ylfyfs, create_time, create_by)
	    values (#{id}, #{no}, #{name}, #{abbr}, #{birthday}, #{age}, 
	      #{weight}, #{sex}, #{ethic}, #{hys}, #{height}, #{yyks}, #{ryrq}, #{cyrq}, #{ylfyfs}, 
	      current_timestamp(), createBy)
	</update>
	<select id="getDoubtCRFNum" parameterType="string" resultType="int">
		select count(*) from crf_user_sign c where c.lockstatus=30 and cro_name=#{userName}
	</select>
  	<select id="getToDoNum" parameterType="string" resultType="int">
		select count(*) from crf_user_sign c where c.lockstatus=10 and cro_name=#{userName}
	</select>
	<select id="getPatientList" parameterType="cn.com.ecrf.trq.model.list.ListCondition" resultType="cn.com.ecrf.trq.model.list.ListReturn">
		select 
			p.abbr as abbr,
			p.no as no,
			p.id as id,
			us.cro_createtime as createDate,
			us.cro_updatetime as lastModified,
			us.progress as progress
		 from crf_patient_info p, crf_user_sign us where c.lockstatus=#{lockStatus}
		 <if test="abbr != null" >
        	and p.abbr=#{abbr}
      	</if>
      	<if test="no != null" >
        	and p.no=#{no}
      	</if>
      	<if test="createDateForm != null" >
        	and us.cro_createtime>=#{createDateForm} and #{createDateTo}>=us.cro_createtime
      	</if>
      	<if test="lastModifiedFrom != null" >
        	and us.cro_updatetime>=#{lastModifiedFrom} and #{lastModifiedTo}>=us.cro_updatetime
      	</if>
	</select>
	<select id="getDoutSummaryList" parameterType="cn.com.ecrf.trq.model.list.ListCondition" resultType="cn.com.ecrf.trq.model.list.ListReturn">
		select 
			p.abbr as abbr,
			p.no as no,
			p.id as id,
			us.cro_createtime as createDate,
			us.cro_updatetime as lastModified,
			us.progress as progress,
			
		 from crf_patient_info p, crf_user_sign us where c.lockstatus=#{lockStatus}
		 <if test="abbr != null" >
        	and p.abbr=#{abbr}
      	</if>
      	<if test="no != null" >
        	and p.no=#{no}
      	</if>
      	<if test="createDateForm != null" >
        	and us.cro_createtime>=#{createDateForm} and #{createDateTo}>=us.cro_createtime
      	</if>
      	<if test="lastModifiedFrom != null" >
        	and us.cro_updatetime>=#{lastModifiedFrom} and #{lastModifiedTo}>=us.cro_updatetime
      	</if>
	</select>
	
	
</mapper>